!function(t){"use strict";function e(t,e,s,i){var o,n=arguments.length,a=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,i);else for(var d=t.length-1;d>=0;d--)(o=t[d])&&(a=(n<3?o(a):n>3?o(e,s,a):o(e,s))||a);return n>3&&a&&Object.defineProperty(e,s,a),a}function s(t,e,s,i){return new(s||(s=Promise))((function(o,n){function a(t){try{r(i.next(t))}catch(t){n(t)}}function d(t){try{r(i.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,d)}r((i=i.apply(t,e||[])).next())}))}class i{constructor(t){this.animation=t}}class o{constructor(t){this.fsm=t}}class n{constructor(){this.toPlay=[]}play(t){this.toPlay.push(t)}}class a{constructor(t){this.lifeTime=t}}class d{constructor(t=0){this.radius=t}}class r{constructor(t){this.countdown=t}}class h{constructor(t){this.displayObject=t}}class c{constructor(){this.lives=0,this.level=0,this.hits=0,this.playing=!1}setForStart(){this.lives=3,this.level=0,this.hits=0,this.playing=!0}}class l{constructor(t,e,s=0,i=0){this.shooting=!1,this.timeSinceLastShot=0,this.offsetFromParentX=t,this.offsetFromParentY=e,this.minimumShotInterval=s,this.bulletLifetime=i}}class p{constructor(t=0){this.trigger=t}}class y{constructor(t){this.view=t}}class u{constructor(t,e,s=0,i=0){this.velocityX=t,this.velocityY=e,this.angularVelocity=s,this.damping=i}}class m{constructor(t=0,e=0,s=0,i=0,o=0){this.left=t,this.right=e,this.accelerate=s,this.accelerationRate=i,this.rotationRate=o}}class w{constructor(t,e,s=0){this.x=t,this.y=e,this.rotation=s}static distance(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}}class f{constructor(t){this.fsm=t}}class g{constructor(t){this.startGame=!1,this.waitForStart=t,t.click.add(()=>{this.startGame=!0})}}class v{constructor(){this.x=0,this.y=0,this.r=0,this.onAdded=new t.Signal0,this.onRemoved=new t.Signal0,this.element=document.createElementNS("http://www.w3.org/2000/svg","g")}setTransform(t=0,e=0,s=0){return this.x=t,this.y=e,this.r=s,this.setAttribute("transform",`translate(${t}, ${e}) rotate(${180*s/Math.PI})`)}setContent(t){return this.element.innerHTML=t,this}setAttribute(t,e){return this.element.setAttribute(t,e),this}addChild(t){this.element.appendChild(t.element)}removeChild(t){this.element.removeChild(t.element)}}class x extends v{constructor(t){super();const e=2*Math.random()*Math.PI,s=Math.random()*t,i=10*Math.random()+10;this.velocityX=Math.cos(e)*i,this.velocityY=Math.sin(e)*i,this.setContent('<circle fill="#fff" cx="1" cy="1" r="1"/>').setTransform(Math.cos(e)*s,Math.sin(e)*s)}}class k extends v{constructor(t){super(),this.dots=[];const e=k.numDots;for(let s=0;s<e;s+=1){const e=new x(t);this.addChild(e),this.dots.push(e)}}animate(t){for(const e of this.dots)e.setTransform(e.x+e.velocityX*t,e.y+e.velocityY*t)}}k.numDots=8;class S extends v{constructor(t){super();let e="",s=0;for(e+=`M${t} 0`;s<2*Math.PI;){const i=(.75+.25*Math.random())*t;e+=`L${Math.cos(s)*i} ${Math.sin(s)*i} `,s+=.5*Math.random()}e+=`L${t} 0`,this.setContent(`<path d="${e}" fill="#fff"/>`)}}class L extends v{constructor(){super(),this.setContent('<g><circle cx="0" cy="0" r="2.5" fill="#fff"/></g>')}}class M extends v{constructor(){super(),this.setTransform(400,50),this.score=(new v).setTransform(-200,0),this.addChild(this.score),this.lives=(new v).setTransform(200,0),this.addChild(this.lives),this.setScore(0),this.setLives(3)}setScore(t){this.score.setContent(`<text>SCORE: ${t}</text>`)}setLives(t){this.lives.setContent(`<text>LIVES: ${t}</text>`)}}class C extends v{constructor(){super(),this.shape1=(new v).setContent('<path d="M10 0 L-7 7 L-4 0 L10 0" fill="#fff"/>'),this.addChild(this.shape1),this.shape2=(new v).setContent('<path d="M10 0 L-7 -7 L-4 0 L10 0" fill="#fff"/>'),this.addChild(this.shape2),this.vel1x=10*Math.random()-5,this.vel1y=10*Math.random()+10,this.vel2x=10*Math.random()-5,this.vel2y=-10*Math.random()-10,this.rot1=3*Math.random()-1.5,this.rot2=3*Math.random()-1.5}animate(t){const{shape1:e,shape2:s}=this;e.setTransform(e.x+this.vel1x*t,e.y+this.vel1y*t,e.r+this.rot1*t),s.setTransform(s.x+this.vel2x*t,s.y+this.vel2y*t,s.r+this.rot2*t)}}class E extends v{constructor(){super(),this.setContent('<path d="M10 0 L-7 7 L-4 0 L-7 -7 L10 0" fill="#fff"/>')}}class N extends v{constructor(){super(),this.click=new t.Signal0,this.dispatchClick=()=>{this.click.dispatch()},this.addClickListener=()=>{window.addEventListener("click",this.dispatchClick)},this.removeClickListener=()=>{window.removeEventListener("click",this.dispatchClick),this.gameOver.setContent('<text class="h1">GAME OVER</text>')},this.gameOver=(new v).setContent('<text class="h1">ASTEROIDS</text>').setTransform(0,-50,0),this.addChild(this.gameOver),this.clickToStart=(new v).setContent('<text class="h2">Click to start</text>').setTransform(0,50,0),this.addChild(this.clickToStart),this.onAdded.add(this.addClickListener),this.onRemoved.add(this.removeClickListener)}}class b{constructor(t,e){this.engine=t,this.config=e}destroyEntity(t){this.engine.removeEntity(t)}createGame(){const e=new M,s=new t.Entity("game").add(new c).add(new y(e)).add(new h(e)).add(new w(this.config.width/2,25,0));return this.engine.addEntity(s),s}createWaitForClick(){if(!this.waitEntity){const e=new N;this.waitEntity=new t.Entity("wait").add(new g(e)).add(new h(e)).add(new w(this.config.width/2,this.config.height/2,0))}return this.waitEntity.get(g).startGame=!1,this.engine.addEntity(this.waitEntity),this.waitEntity}createAsteroid(e,s,a){const c=new t.Entity,l=new t.EntityStateMachine(c),p=4*(Math.random()-.5)*(50-e),y=4*(Math.random()-.5)*(50-e),m=2*Math.random()-1;l.createState("alive").add(u).withInstance(new u(p,y,m)).add(d).withInstance(new d(e)).add(h).withInstance(new h(new S(e)));const f=new k(e);return l.createState("destroyed").add(r).withInstance(new r(3)).add(h).withInstance(new h(f)).add(i).withInstance(new i(f)),c.add(new o(l)).add(new w(s,a,0)).add(new n),l.changeState("alive"),this.engine.addEntity(c),c}createSpaceship(){const e=new t.Entity,s=new t.EntityStateMachine(e);s.createState("playing").add(u).withInstance(new u(0,0,0,15)).add(m).withInstance(new m(37,39,38,100,3)).add(l).withInstance(new l(8,0,.3,2)).add(p).withInstance(new p(32)).add(d).withInstance(new d(9)).add(h).withInstance(new h(new E));const o=new C;return s.createState("destroyed").add(r).withInstance(new r(5)).add(h).withInstance(new h(o)).add(i).withInstance(new i(o)),e.add(new f(s)).add(new w(this.config.width/2,this.config.height/2,0)).add(new n),s.changeState("playing"),this.engine.addEntity(e),e}createUserBullet(e,s){const i=Math.cos(s.rotation),o=Math.sin(s.rotation),n=(new t.Entity).add(new a(e.bulletLifetime)).add(new w(i*e.offsetFromParentX-o*e.offsetFromParentY+s.x,o*e.offsetFromParentX+i*e.offsetFromParentY+s.y,0)).add(new d(0)).add(new u(150*i,150*o,0,0)).add(new h(new L));return this.engine.addEntity(n),n}}class I{constructor(t,e){this.width=t,this.height=e}}class T{constructor(){this.keys=new Int32Array(4),this.keyDownHandler=t=>{const{keyCode:e}=t,s=Math.floor(e/32);this.keys[s]|=1<<e-32*s},this.keyUpHandler=t=>{const{keyCode:e}=t,s=Math.floor(e/32);this.keys[s]&=~(1<<e-32*s)},window.addEventListener("keyup",this.keyUpHandler),window.addEventListener("keydown",this.keyDownHandler)}isDown(t){const e=Math.floor(t/32);return 0!=(this.keys[e]&1<<t-32*e)}isUp(t){return!this.isDown(t)}}class P extends t.Node{}e([t.keep(i)],P.prototype,"animation",void 0);class D extends t.Node{}e([t.keep(o)],D.prototype,"asteroid",void 0),e([t.keep(w)],D.prototype,"position",void 0),e([t.keep(d)],D.prototype,"collision",void 0),e([t.keep(n)],D.prototype,"audio",void 0);class F extends t.Node{}e([t.keep(n)],F.prototype,"audio",void 0);class A extends t.Node{}e([t.keep(a)],A.prototype,"bullet",void 0);class R extends t.Node{}e([t.keep(a)],R.prototype,"bullet",void 0),e([t.keep(w)],R.prototype,"position",void 0),e([t.keep(d)],R.prototype,"collision",void 0);class O extends t.Node{}e([t.keep(r)],O.prototype,"death",void 0);class X extends t.Node{}e([t.keep(c)],X.prototype,"state",void 0);class Y extends t.Node{}e([t.keep(p)],Y.prototype,"control",void 0),e([t.keep(l)],Y.prototype,"gun",void 0),e([t.keep(w)],Y.prototype,"position",void 0),e([t.keep(n)],Y.prototype,"audio",void 0);class $ extends t.Node{}e([t.keep(c)],$.prototype,"state",void 0),e([t.keep(y)],$.prototype,"hud",void 0);class U extends t.Node{}e([t.keep(m)],U.prototype,"control",void 0),e([t.keep(w)],U.prototype,"position",void 0),e([t.keep(u)],U.prototype,"motion",void 0);class j extends t.Node{}e([t.keep(w)],j.prototype,"position",void 0),e([t.keep(u)],j.prototype,"motion",void 0);class G extends t.Node{}e([t.keep(w)],G.prototype,"position",void 0),e([t.keep(h)],G.prototype,"display",void 0);class B extends t.Node{}e([t.keep(f)],B.prototype,"spaceship",void 0),e([t.keep(w)],B.prototype,"position",void 0),e([t.keep(d)],B.prototype,"collision",void 0),e([t.keep(n)],B.prototype,"audio",void 0);class H extends t.Node{}e([t.keep(f)],H.prototype,"spaceship",void 0),e([t.keep(w)],H.prototype,"position",void 0);class V extends t.Node{}e([t.keep(g)],V.prototype,"wait",void 0);class W extends t.ListIteratingSystem{constructor(){super(P)}updateNode(t,e){t.animation.animation.animate(e)}}class q extends t.ListIteratingSystem{constructor(t,e){super(F),this.audioContext=t,this.audioDB=e}updateNode(t,e){for(const e of t.audio.toPlay){const t=this.audioDB.get(e)||null,s=this.audioContext.createBufferSource();s.buffer=t,s.connect(this.audioContext.destination),s.start(0)}t.audio.toPlay.length=0}}class z extends t.ListIteratingSystem{constructor(t){super(A),this.creator=t}updateNode(t,e){const{bullet:s}=t;s.lifeTime-=e,s.lifeTime<=0&&this.creator.destroyEntity(t.entity)}}var J;!function(t){t[t.asteroid=0]="asteroid",t[t.ship=1]="ship",t[t.shoot=2]="shoot"}(J||(J={}));const K=[{key:J.asteroid,mp3:"652cd14a66ffc75b.mp3",ogg:"930cfba647e62b00.ogg"},{key:J.shoot,mp3:"2520559ca39a00c2.mp3",ogg:"e25571a4800a2db8.ogg"},{key:J.ship,mp3:"841ef5131f04838e.mp3",ogg:"919aafd2357b080a.ogg"}];function Q(t){return s(this,void 0,void 0,(function*(){const e=new Map,i=function(){const t=document.createElement("audio"),e=t.canPlayType("audio/mpeg"),s=t.canPlayType("audio/ogg");let i=null;return"probably"===e?i="mp3":"probably"===s?i="ogg":"maybe"===e?i="mp3":"maybe"===s&&(i="ogg"),i}(),o=(i,o)=>s(this,void 0,void 0,(function*(){const s=yield fetch(i),n=yield s.arrayBuffer(),a=yield t.decodeAudioData(n);e.set(o,a)}));return i&&(yield Promise.all(K.map(t=>o(t[i],t.key)))),e}))}class Z extends t.System{constructor(t){super(),this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null,this.creator=t}addToEngine(t){this.games=t.getNodeList(X),this.spaceships=t.getNodeList(B),this.asteroids=t.getNodeList(D),this.bullets=t.getNodeList(R)}update(t){for(let t=this.bullets.head;t;t=t.next)for(let e=this.asteroids.head;e;e=e.next){if(w.distance(e.position,t.position)<=e.collision.radius){if(this.creator.destroyEntity(t.entity),e.collision.radius>10){const t=e.collision.radius-10;let s=e.position.x+10*Math.random()-5,i=e.position.y+10*Math.random()-5;this.creator.createAsteroid(t,s,i),s=e.position.x+10*Math.random()-5,i=e.position.y+10*Math.random()-5,this.creator.createAsteroid(t,s,i)}e.asteroid.fsm.changeState("destroyed"),e.audio.play(J.asteroid),this.games.head&&(this.games.head.state.hits+=1);break}}for(let t=this.spaceships.head;t;t=t.next)for(let e=this.asteroids.head;e;e=e.next){if(w.distance(e.position,t.position)<=e.collision.radius+t.collision.radius){t.spaceship.fsm.changeState("destroyed"),t.audio.play(J.ship),this.games.head&&(this.games.head.state.lives-=1);break}}}removeFromEngine(t){this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null}}class _ extends t.ListIteratingSystem{constructor(t){super(O),this.creator=t}updateNode(t,e){t.death.countdown-=e,t.death.countdown<=0&&this.creator.destroyEntity(t.entity)}}class tt extends t.System{constructor(t,e){super(),this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null,this.creator=t,this.config=e}addToEngine(t){this.games=t.getNodeList(X),this.spaceships=t.getNodeList(H),this.asteroids=t.getNodeList(D),this.bullets=t.getNodeList(R)}update(t){const e=this.games.head;if(e&&e.state.playing){if(this.spaceships.empty)if(e.state.lives>0){const t=this.config.width/2,e=this.config.height/2;let s=!0;for(let i=this.asteroids.head;i;i=i.next){if(w.distance(i.position,{x:t,y:e})<=i.collision.radius+50){s=!1;break}}s&&this.creator.createSpaceship()}else e.state.playing=!1,this.creator.createWaitForClick();if(this.asteroids.empty&&this.bullets.empty&&this.spaceships.head){const t=this.spaceships.head;e.state.level+=1;const s=2+e.state.level;for(let e=0;e<s;e+=1){let e,s;do{e=Math.random()*this.config.width,s=Math.random()*this.config.height}while(w.distance({x:e,y:s},t.position)<=80);this.creator.createAsteroid(30,e,s)}}}}removeFromEngine(t){this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null}}class et extends t.ListIteratingSystem{constructor(t,e){super(Y),this.keyPoll=t,this.creator=e}updateNode(t,e){const{control:s}=t,{position:i}=t,{gun:o}=t;o.shooting=this.keyPoll.isDown(s.trigger),o.timeSinceLastShot+=e,o.shooting&&o.timeSinceLastShot>=o.minimumShotInterval&&(this.creator.createUserBullet(o,i),t.audio.play(J.shoot),o.timeSinceLastShot=0)}}class st extends t.ListIteratingSystem{constructor(){super($)}updateNode(t,e){t.hud.view.setLives(t.state.lives),t.hud.view.setScore(t.state.hits)}}class it extends t.ListIteratingSystem{constructor(t){super(U),this.keyPoll=t}updateNode(t,e){const{control:s}=t,{position:i}=t,{motion:o}=t;this.keyPoll.isDown(s.left)&&(i.rotation-=s.rotationRate*e),this.keyPoll.isDown(s.right)&&(i.rotation+=s.rotationRate*e),this.keyPoll.isDown(s.accelerate)&&(o.velocityX+=Math.cos(i.rotation)*s.accelerationRate*e,o.velocityY+=Math.sin(i.rotation)*s.accelerationRate*e)}}class ot extends t.ListIteratingSystem{constructor(t){super(j),this.config=t}updateNode(t,e){const{position:s,motion:i}=t,{width:o,height:n}=this.config;if(s.x+=i.velocityX*e,s.y+=i.velocityY*e,s.x<0&&(s.x+=o),s.x>o&&(s.x-=o),s.y<0&&(s.y+=n),s.y>n&&(s.y-=n),s.rotation+=i.angularVelocity*e,i.damping>0){const t=Math.abs(Math.cos(s.rotation)*i.damping*e),o=Math.abs(Math.sin(s.rotation)*i.damping*e);i.velocityX>t?i.velocityX-=t:i.velocityX<-t?i.velocityX+=t:i.velocityX=0,i.velocityY>o?i.velocityY-=o:i.velocityY<-o?i.velocityY+=o:i.velocityY=0}}}class nt extends t.System{constructor(t){super(),this.nodes=null,this.addToDisplay=t=>{const{displayObject:e}=t.display;this.container.appendChild(e.element),e.onAdded.dispatch()},this.removeFromDisplay=t=>{const{displayObject:e}=t.display;this.container.removeChild(t.display.displayObject.element),e.onRemoved.dispatch()},this.container=t}addToEngine(t){this.nodes=t.getNodeList(G);for(let t=this.nodes.head;t;t=t.next)this.addToDisplay(t);this.nodes.nodeAdded.add(this.addToDisplay),this.nodes.nodeRemoved.add(this.removeFromDisplay)}update(t){for(let t=this.nodes.head;t;t=t.next){const{display:e,position:s}=t;e.displayObject.setTransform(s.x,s.y,s.rotation)}}removeFromEngine(t){this.nodes=null}}var at;!function(t){t[t.preUpdate=1]="preUpdate",t[t.update=2]="update",t[t.move=3]="move",t[t.resolveCollisions=4]="resolveCollisions",t[t.animate=5]="animate",t[t.render=6]="render",t[t.audio=7]="audio"}(at||(at={}));class dt extends t.System{constructor(t){super(),this.gameNodes=null,this.waitNodes=null,this.asteroids=null,this.creator=t}addToEngine(t){this.waitNodes=t.getNodeList(V),this.gameNodes=t.getNodeList(X),this.asteroids=t.getNodeList(D)}update(t){if(!this.waitNodes||!this.gameNodes||!this.asteroids)return;const e=this.waitNodes.head,s=this.gameNodes.head;if(e&&e.wait.startGame&&s){for(let t=this.asteroids.head;t;t=t.next)t.entity&&this.creator.destroyEntity(t.entity);s.state.setForStart(),e.wait.startGame=!1,e.entity&&this.creator.destroyEntity(e.entity)}}removeFromEngine(t){this.gameNodes=null,this.waitNodes=null,this.asteroids=null}}window.addEventListener("load",()=>s(void 0,void 0,void 0,(function*(){const e=document.getElementById("game");e&&(yield function(e){return s(this,void 0,void 0,(function*(){const s=new I(e.clientWidth,e.clientHeight),i=new t.Engine,o=new b(i,s),n=new T,a=new t.FrameTickProvider,d=new AudioContext,r=yield Q(d);a.add(t=>i.update(t)),a.start(),i.addSystem(new dt(o),at.preUpdate),i.addSystem(new tt(o,s),at.preUpdate),i.addSystem(new it(n),at.update),i.addSystem(new et(n,o),at.update),i.addSystem(new z(o),at.update),i.addSystem(new _(o),at.update),i.addSystem(new ot(s),at.move),i.addSystem(new Z(o),at.resolveCollisions),i.addSystem(new W,at.animate),i.addSystem(new st,at.animate),i.addSystem(new nt(e),at.render),i.addSystem(new q(d,r),at.audio),o.createWaitForClick(),o.createGame()}))}(e))})))}(ASH);
