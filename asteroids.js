!function(){"use strict";function t(t,e,s,i){var n,o=arguments.length,a=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,i);else for(var h=t.length-1;h>=0;h--)(n=t[h])&&(a=(o<3?n(a):o>3?n(e,s,a):n(e,s))||a);return o>3&&a&&Object.defineProperty(e,s,a),a}function e(t,e,s,i){return new(s||(s=Promise))((function(n,o){function a(t){try{r(i.next(t))}catch(t){o(t)}}function h(t){try{r(i.throw(t))}catch(t){o(t)}}function r(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,h)}r((i=i.apply(t,e||[])).next())}))}class s{constructor(){this.previous=null,this.next=null,this.once=!1}}class i{constructor(){this.tail=null,this.cacheTail=null}get(){if(this.tail){const t=this.tail;return this.tail=this.tail.previous,t.previous=null,t}return new s}dispose(t){t.listener=null,t.once=!1,t.next=null,t.previous=this.tail,this.tail=t}cache(t){t.listener=null,t.previous=this.cacheTail,this.cacheTail=t}releaseCache(){for(;this.cacheTail;){const t=this.cacheTail;this.cacheTail=t.previous,t.next=null,t.previous=this.tail,this.tail=t}}}class n{constructor(){this.head=null,this.tail=null,this.toAddHead=null,this.toAddTail=null,this.dispatching=!1,this._numListeners=0,this.nodes=new Map,this.listenerNodePool=new i}startDispatch(){this.dispatching=!0}endDispatch(){this.dispatching=!1,this.toAddHead&&(this.head?(this.tail.next=this.toAddHead,this.toAddHead.previous=this.tail,this.tail=this.toAddTail):(this.head=this.toAddHead,this.tail=this.toAddTail),this.toAddHead=null,this.toAddTail=null),this.listenerNodePool.releaseCache()}get numListeners(){return this._numListeners}add(t){if(this.nodes.has(t))return;const e=this.listenerNodePool.get();e.listener=t,this.nodes.set(t,e),this.addNode(e)}addOnce(t){if(this.nodes.has(t))return;const e=this.listenerNodePool.get();e.listener=t,e.once=!0,this.nodes.set(t,e),this.addNode(e)}addNode(t){this.dispatching?this.toAddHead?(this.toAddTail.next=t,t.previous=this.toAddTail,this.toAddTail=t):(this.toAddHead=t,this.toAddTail=t):this.head?(this.tail.next=t,t.previous=this.tail,this.tail=t):(this.head=t,this.tail=t),this._numListeners+=1}remove(t){const e=this.nodes.get(t)||null;e&&(this.head===e&&(this.head=this.head.next),this.tail===e&&(this.tail=this.tail.previous),this.toAddHead===e&&(this.toAddHead=this.toAddHead.next),this.toAddTail===e&&(this.toAddTail=this.toAddTail.previous),e.previous&&(e.previous.next=e.next),e.next&&(e.next.previous=e.previous),this.nodes.delete(t),this.dispatching?this.listenerNodePool.cache(e):this.listenerNodePool.dispose(e),this._numListeners-=1)}removeAll(){for(;this.head;){const t=this.head;this.head=this.head.next,this.nodes.delete(t.listener),this.listenerNodePool.dispose(t)}this.tail=null,this.toAddHead=null,this.toAddTail=null,this._numListeners=0}}class o extends n{dispatch(){this.startDispatch();for(let t=this.head;t;t=t.next)t.listener(),t.once&&this.remove(t.listener);this.endDispatch()}}class a extends n{dispatch(t){this.startDispatch();for(let e=this.head;e;e=e.next)e.listener(t),e.once&&this.remove(e.listener);this.endDispatch()}}class h extends n{dispatch(t,e){this.startDispatch();for(let s=this.head;s;s=s.next)s.listener(t,e),s.once&&this.remove(s.listener);this.endDispatch()}}class r{constructor(){this.head=null,this.tail=null,this.nodeAdded=new a,this.nodeRemoved=new a}add(t){this.head?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null),this.nodeAdded.dispatch(t)}remove(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous),this.nodeRemoved.dispatch(t)}removeAll(){for(;this.head;){const t=this.head;this.head=t.next,t.previous=null,t.next=null,this.nodeRemoved.dispatch(t)}this.tail=null}get empty(){return null==this.head}swap(t,e){if(t.previous===e)t.previous=e.previous,e.previous=t,e.next=t.next,t.next=e;else if(e.previous===t)e.previous=t.previous,t.previous=e,t.next=e.next,e.next=t;else{let s=t.previous;t.previous=e.previous,e.previous=s,s=t.next,t.next=e.next,e.next=s}this.head===t?this.head=e:this.head===e&&(this.head=t),this.tail===t?this.tail=e:this.tail===e&&(this.tail=t),t.previous&&(t.previous.next=t),e.previous&&(e.previous.next=e),t.next&&(t.next.previous=t),e.next&&(e.next.previous=e)}insertionSort(t){if(!this.head||!this.tail||this.head===this.tail)return;let e=this.head.next;for(let s=e;s;s=e){let i;for(e=s.next,i=s.previous;i;i=i.previous)if(t(s,i)>=0){s!==i.next&&(this.tail===s&&(this.tail=s.previous),s.previous.next=s.next,s.next&&(s.next.previous=s.previous),s.next=i.next,s.previous=i,s.next.previous=s,i.next=s);break}i||(this.tail===s&&(this.tail=s.previous),s.previous.next=s.next,s.next&&(s.next.previous=s.previous),s.next=this.head,this.head.previous=s,s.previous=null,this.head=s)}}mergeSort(t){if(this.head===this.tail)return;const e=[];let s,i=this.head;for(;i;){for(s=i;s.next&&t(s,s.next)<=0;)s=s.next;const n=s.next;i.previous=null,s.next=null,e[e.length]=i,i=n}for(;e.length>1;)e.push(this.merge(e.shift(),e.shift(),t));for([this.tail]=e,[this.head]=e;this.tail.next;)this.tail=this.tail.next}merge(t,e,s){let i,n,o=t,a=e;for(s(o,a)<=0?(n=o,i=o,o=o.next):(n=a,i=a,a=a.next);o&&a;)s(o,a)<=0?(i.next=o,o.previous=i,i=o,o=o.next):(i.next=a,a.previous=i,i=a,a=a.next);return o?(i.next=o,o.previous=i):(i.next=a,a.previous=i),n}}class d{constructor(t,e){this.tail=null,this.cacheTail=null,this.NodeClass=t,this.components=e}get(){if(this.tail){const t=this.tail;return this.tail=this.tail.previous,t.previous=null,t}return new this.NodeClass}dispose(t){for(const e of this.components.values())t[e]=null;t.entity=null,t.next=null,t.previous=this.tail,this.tail=t}cache(t){t.previous=this.cacheTail,this.cacheTail=t}releaseCache(){for(;this.cacheTail;){const t=this.cacheTail;this.cacheTail=t.previous,this.dispose(t)}}}const l="__ash_types__";class c{constructor(t,e){this.releaseNodePoolCache=()=>{this.engine.updateComplete.remove(this.releaseNodePoolCache),this.nodePool.releaseCache()},this.nodeClass=t,this.engine=e,this.nodes=new r,this.entities=new Map,this.components=new Map,this.nodePool=new d(this.nodeClass,this.components);const s=this.nodePool.get();this.nodePool.dispose(s);const i=s.constructor[l];for(const[t,e]of i)this.components.set(e,t)}get nodeList(){return this.nodes}newEntity(t){this.addIfMatch(t)}componentAddedToEntity(t,e){this.addIfMatch(t)}componentRemovedFromEntity(t,e){this.components.has(e)&&this.removeIfMatch(t)}removeEntity(t){this.removeIfMatch(t)}addIfMatch(t){if(!this.entities.has(t)){for(const e of this.components.keys())if(!t.has(e))return;const e=this.nodePool.get();e.entity=t;for(const s of this.components.keys()){e[this.components.get(s)]=t.get(s)}this.entities.set(t,e),this.nodes.add(e)}}removeIfMatch(t){if(this.entities.has(t)){const e=this.entities.get(t);this.entities.delete(t),this.nodes.remove(e),this.engine.updating?(this.nodePool.cache(e),this.engine.updateComplete.add(this.releaseNodePoolCache)):this.nodePool.dispose(e)}}cleanUp(){for(let t=this.nodes.head;t;t=t.next)this.entities.delete(t.entity);this.nodes.removeAll()}}function u(t){return(e,s)=>{const i=e.constructor;let n;i.hasOwnProperty(l)?n=i[l]:(n=new Map,Object.defineProperty(i,l,{enumerable:!0,get:()=>n})),n.set(s,t)}}class p{constructor(){this.head=null,this.tail=null}add(t){this.head?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):(this.head=t,this.tail=t,t.next=null,t.previous=null)}remove(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}}class m{constructor(){this.head=null,this.tail=null}add(t){if(this.head){let e;for(e=this.tail;e&&!(e.priority<=t.priority);e=e.previous);e===this.tail?(this.tail.next=t,t.previous=this.tail,t.next=null,this.tail=t):e?(t.next=e.next,t.previous=e,e.next.previous=t,e.next=t):(t.next=this.head,t.previous=null,this.head.previous=t,this.head=t)}else this.head=t,this.tail=t,t.next=null,t.previous=null}remove(t){this.head===t&&(this.head=this.head.next),this.tail===t&&(this.tail=this.tail.previous),t.previous&&(t.previous.next=t.next),t.next&&(t.next.previous=t.previous)}get(t){for(let e=this.head;e;e=e.next)if(e instanceof t)return e;return null}}class v{constructor(){this.updating=!1,this.FamilyClass=c,this.entityNameChanged=(t,e)=>{this.entityNames.get(e)===t&&(this.entityNames.delete(e),this.entityNames.set(t.name,t))},this.componentAdded=(t,e)=>{for(const s of this.families.values())s.componentAddedToEntity(t,e)},this.componentRemoved=(t,e)=>{for(const s of this.families.values())s.componentRemovedFromEntity(t,e)},this.entityList=new p,this.entityNames=new Map,this.systemList=new m,this.families=new Map,this.updateComplete=new o}addEntity(t){if(this.entityNames.has(t.name))throw new Error(`The entity name ${t.name} is already in use by another entity.`);this.entityList.add(t),this.entityNames.set(t.name,t),t.componentAdded.add(this.componentAdded),t.componentRemoved.add(this.componentRemoved),t.nameChanged.add(this.entityNameChanged);for(const e of this.families.values())e.newEntity(t)}removeEntity(t){t.componentAdded.remove(this.componentAdded),t.componentRemoved.remove(this.componentRemoved),t.nameChanged.remove(this.entityNameChanged);for(const e of this.families.values())e.removeEntity(t);this.entityNames.delete(t.name),this.entityList.remove(t)}getEntityByName(t){return this.entityNames.get(t)||null}removeAllEntities(){for(;this.entityList.head;)this.removeEntity(this.entityList.head)}get entities(){const t=[];for(let e=this.entityList.head;e;e=e.next)t[t.length]=e;return t}getNodeList(t){if(this.families.has(t))return this.families.get(t).nodeList;const e=new this.FamilyClass(t,this);this.families.set(t,e);for(let t=this.entityList.head;t;t=t.next)e.newEntity(t);return e.nodeList}releaseNodeList(t){this.families.has(t)&&this.families.get(t).cleanUp(),this.families.delete(t)}addSystem(t,e){t.priority=e,t.addToEngine(this),this.systemList.add(t)}getSystem(t){return this.systemList.get(t)}get systems(){const t=[];for(let e=this.systemList.head;e;e=e.next)t[t.length]=e;return t}removeSystem(t){this.systemList.remove(t),t.removeFromEngine(this)}removeAllSystems(){for(;this.systemList.head;){const t=this.systemList.head;this.systemList.head=this.systemList.head.next,t.previous=null,t.next=null,t.removeFromEngine(this)}this.systemList.tail=null}update(t){this.updating=!0;for(let e=this.systemList.head;e;e=e.next)e.update(t);this.updating=!1,this.updateComplete.dispatch()}}class y{constructor(t=""){this.previous=null,this.next=null,this.componentAdded=new h,this.componentRemoved=new h,this.nameChanged=new h,this.components=new Map,t?this._name=t:(y.nameCount+=1,this._name="_entity"+y.nameCount)}get name(){return this._name}set name(t){if(this._name!==t){const e=this._name;this._name=t,this.nameChanged.dispatch(this,e)}}add(t,e=null){let s=e;if(e||(s=t.constructor.prototype.constructor),!s)throw new Error("Unable to get type of component: "+t);return this.components.has(s)&&this.remove(s),this.components.set(s,t),this.componentAdded.dispatch(this,s),this}remove(t){const e=this.components.get(t);return e?(this.components.delete(t),this.componentRemoved.dispatch(this,t),e):null}get(t){return this.components.get(t)||null}getAll(){const t=[];for(const e of this.components.values())t.push(e);return t}has(t){return this.components.has(t)}}y.nameCount=0;class f{constructor(){this.previous=null,this.next=null}}class g{constructor(){this.previous=null,this.next=null,this.priority=0}}class x{constructor(t){this.instance=t}getComponent(){return this.instance}get identifier(){return this.instance}}class w{constructor(t){this.ComponentType=t}getComponent(){return this.instance||(this.instance=new this.ComponentType),this.instance}get identifier(){return this.getComponent()}}class C{constructor(t){this.ComponentType=t}getComponent(){return new this.ComponentType}get identifier(){return this.ComponentType}}class L{constructor(t){this.closure=t}getComponent(){return this.closure()}get identifier(){return this.closure}}class T{constructor(t,e){this.creatingState=t,this.componentType=e,this.withType(e)}withInstance(t){return this.setProvider(new x(t)),this}withType(t){return this.setProvider(new C(t)),this}withSingleton(t=this.componentType){return this.setProvider(new w(t)),this}withMethod(t){return this.setProvider(new L(t)),this}withProvider(t){return this.setProvider(t),this}add(t){return this.creatingState.add(t)}setProvider(t){this.provider=t,this.creatingState.providers.set(this.componentType,t)}}class A{constructor(){this.providers=new Map}add(t){return new T(this,t)}get(t){return this.providers.get(t)||null}has(t){return this.providers.has(t)}}class M{constructor(t){this.entity=t,this.states=new Map}addState(t,e){return this.states.set(t,e),this}createState(t){const e=new A;return this.states.set(t,e),e}changeState(t){const e=this.states.get(t);if(!e)throw new Error(`Entity state ${t} doesn't exist`);if(e===this.currentState)return;let s;if(this.currentState){s=new Map;for(const t of e.providers.keys())s.set(t,e.providers.get(t));for(const t of this.currentState.providers.keys()){const e=s.get(t)||null;e&&e.identifier===this.currentState.providers.get(t).identifier?s.delete(t):this.entity.remove(t)}}else s=e.providers;for(const t of s.keys())this.entity.add(s.get(t).getComponent(),t);this.currentState=e}getStateNames(){return Object.keys(this.states)}}class S extends a{constructor(t=Number.MAX_VALUE){super(),this.rafId=0,this.previousTime=0,this.maximumFrameTime=0,this.timeAdjustment=1,this.dispatchTick=()=>{this.rafId=requestAnimationFrame(this.dispatchTick);const t=this.previousTime;this.previousTime=performance.now();let e=(this.previousTime-t)/1e3;e>this.maximumFrameTime&&(e=this.maximumFrameTime),this.dispatch(e*this.timeAdjustment)},this.maximumFrameTime=t}start(){this.rafId=requestAnimationFrame(this.dispatchTick),this.previousTime=performance.now()}stop(){cancelAnimationFrame(this.rafId),this.rafId=0}get isPlaying(){return!!this.rafId}}class N extends g{constructor(t){super(),this.nodeList=null,this.nodeClass=t}addToEngine(t){if(this.nodeList=t.getNodeList(this.nodeClass),this.nodeAdded){for(let t=this.nodeList.head;t;t=t.next)this.nodeAdded(t);this.nodeList.nodeAdded.add(this.nodeAdded)}this.nodeRemoved&&this.nodeList.nodeRemoved.add(this.nodeRemoved)}removeFromEngine(){this.nodeAdded&&this.nodeList.nodeAdded.remove(this.nodeAdded),this.nodeRemoved&&this.nodeList.nodeRemoved.remove(this.nodeRemoved),this.nodeList=null}update(t){for(let e=this.nodeList.head;e;e=e.next)this.updateNode(e,t)}}class E{constructor(t){this.animation=t}}class k{constructor(t){this.fsm=t}}class P{constructor(){this.toPlay=[]}play(t){this.toPlay.push(t)}}class b{constructor(t){this.lifeTime=t}}class I{constructor(t=0){this.radius=t}}class R{constructor(t){this.countdown=t}}class F{constructor(t){this.displayObject=t}}class D{constructor(){this.lives=0,this.level=0,this.hits=0,this.playing=!1}setForStart(){this.lives=3,this.level=0,this.hits=0,this.playing=!0}}class H{constructor(t,e,s=0,i=0){this.shooting=!1,this.timeSinceLastShot=0,this.offsetFromParentX=t,this.offsetFromParentY=e,this.minimumShotInterval=s,this.bulletLifetime=i}}class O{constructor(t=0){this.trigger=t}}class _{constructor(t){this.view=t}}class X{constructor(t,e,s=0,i=0){this.velocityX=t,this.velocityY=e,this.angularVelocity=s,this.damping=i}}class U{constructor(t=0,e=0,s=0,i=0,n=0){this.left=t,this.right=e,this.accelerate=s,this.accelerationRate=i,this.rotationRate=n}}class Y{constructor(t,e,s=0){this.x=t,this.y=e,this.rotation=s}static distance(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}}class j{constructor(t){this.fsm=t}}class ${constructor(t){this.startGame=!1,this.waitForStart=t,t.click.add(()=>{this.startGame=!0})}}class B{constructor(){this.x=0,this.y=0,this.r=0,this.onAdded=new o,this.onRemoved=new o,this.element=document.createElementNS("http://www.w3.org/2000/svg","g")}setTransform(t=0,e=0,s=0){return this.x=t,this.y=e,this.r=s,this.setAttribute("transform",`translate(${t}, ${e}) rotate(${180*s/Math.PI})`)}setContent(t){return this.element.innerHTML=t,this}setAttribute(t,e){return this.element.setAttribute(t,e),this}addChild(t){this.element.appendChild(t.element)}removeChild(t){this.element.removeChild(t.element)}}class G extends B{constructor(t){super();const e=2*Math.random()*Math.PI,s=Math.random()*t,i=10*Math.random()+10;this.velocityX=Math.cos(e)*i,this.velocityY=Math.sin(e)*i,this.setContent('<circle fill="#fff" cx="1" cy="1" r="1"/>').setTransform(Math.cos(e)*s,Math.sin(e)*s)}}class V extends B{constructor(t){super(),this.dots=[];const e=V.numDots;for(let s=0;s<e;s+=1){const e=new G(t);this.addChild(e),this.dots.push(e)}}animate(t){for(const e of this.dots)e.setTransform(e.x+e.velocityX*t,e.y+e.velocityY*t)}}V.numDots=8;class W extends B{constructor(t){super();let e="",s=0;for(e+=`M${t} 0`;s<2*Math.PI;){const i=(.75+.25*Math.random())*t;e+=`L${Math.cos(s)*i} ${Math.sin(s)*i} `,s+=.5*Math.random()}e+=`L${t} 0`,this.setContent(`<path d="${e}" fill="#fff"/>`)}}class q extends B{constructor(){super(),this.setContent('<g><circle cx="0" cy="0" r="2.5" fill="#fff"/></g>')}}class z extends B{constructor(){super(),this.setTransform(400,50),this.score=(new B).setTransform(-200,0),this.addChild(this.score),this.lives=(new B).setTransform(200,0),this.addChild(this.lives),this.setScore(0),this.setLives(3)}setScore(t){this.score.setContent(`<text>SCORE: ${t}</text>`)}setLives(t){this.lives.setContent(`<text>LIVES: ${t}</text>`)}}class J extends B{constructor(){super(),this.shape1=(new B).setContent('<path d="M10 0 L-7 7 L-4 0 L10 0" fill="#fff"/>'),this.addChild(this.shape1),this.shape2=(new B).setContent('<path d="M10 0 L-7 -7 L-4 0 L10 0" fill="#fff"/>'),this.addChild(this.shape2),this.vel1x=10*Math.random()-5,this.vel1y=10*Math.random()+10,this.vel2x=10*Math.random()-5,this.vel2y=-10*Math.random()-10,this.rot1=3*Math.random()-1.5,this.rot2=3*Math.random()-1.5}animate(t){const{shape1:e,shape2:s}=this;e.setTransform(e.x+this.vel1x*t,e.y+this.vel1y*t,e.r+this.rot1*t),s.setTransform(s.x+this.vel2x*t,s.y+this.vel2y*t,s.r+this.rot2*t)}}class K extends B{constructor(){super(),this.setContent('<path d="M10 0 L-7 7 L-4 0 L-7 -7 L10 0" fill="#fff"/>')}}class Q extends B{constructor(){super(),this.click=new o,this.dispatchClick=()=>{this.click.dispatch()},this.addClickListener=()=>{window.addEventListener("click",this.dispatchClick)},this.removeClickListener=()=>{window.removeEventListener("click",this.dispatchClick),this.gameOver.setContent('<text class="h1">GAME OVER</text>')},this.gameOver=(new B).setContent('<text class="h1">ASTEROIDS</text>').setTransform(0,-50,0),this.addChild(this.gameOver),this.clickToStart=(new B).setContent('<text class="h2">Click to start</text>').setTransform(0,50,0),this.addChild(this.clickToStart),this.onAdded.add(this.addClickListener),this.onRemoved.add(this.removeClickListener)}}class Z{constructor(t,e){this.engine=t,this.config=e}destroyEntity(t){this.engine.removeEntity(t)}createGame(){const t=new z,e=new y("game").add(new D).add(new _(t)).add(new F(t)).add(new Y(this.config.width/2,25,0));return this.engine.addEntity(e),e}createWaitForClick(){if(!this.waitEntity){const t=new Q;this.waitEntity=new y("wait").add(new $(t)).add(new F(t)).add(new Y(this.config.width/2,this.config.height/2,0))}return this.waitEntity.get($).startGame=!1,this.engine.addEntity(this.waitEntity),this.waitEntity}createAsteroid(t,e,s){const i=new y,n=new M(i),o=4*(Math.random()-.5)*(50-t),a=4*(Math.random()-.5)*(50-t),h=2*Math.random()-1;n.createState("alive").add(X).withInstance(new X(o,a,h)).add(I).withInstance(new I(t)).add(F).withInstance(new F(new W(t)));const r=new V(t);return n.createState("destroyed").add(R).withInstance(new R(3)).add(F).withInstance(new F(r)).add(E).withInstance(new E(r)),i.add(new k(n)).add(new Y(e,s,0)).add(new P),n.changeState("alive"),this.engine.addEntity(i),i}createSpaceship(){const t=new y,e=new M(t);e.createState("playing").add(X).withInstance(new X(0,0,0,15)).add(U).withInstance(new U(37,39,38,100,3)).add(H).withInstance(new H(8,0,.3,2)).add(O).withInstance(new O(32)).add(I).withInstance(new I(9)).add(F).withInstance(new F(new K));const s=new J;return e.createState("destroyed").add(R).withInstance(new R(5)).add(F).withInstance(new F(s)).add(E).withInstance(new E(s)),t.add(new j(e)).add(new Y(this.config.width/2,this.config.height/2,0)).add(new P),e.changeState("playing"),this.engine.addEntity(t),t}createUserBullet(t,e){const s=Math.cos(e.rotation),i=Math.sin(e.rotation),n=(new y).add(new b(t.bulletLifetime)).add(new Y(s*t.offsetFromParentX-i*t.offsetFromParentY+e.x,i*t.offsetFromParentX+s*t.offsetFromParentY+e.y,0)).add(new I(0)).add(new X(150*s,150*i,0,0)).add(new F(new q));return this.engine.addEntity(n),n}}class tt{constructor(t,e){this.width=t,this.height=e}}class et{constructor(){this.keys=new Int32Array(4),this.keyDownHandler=t=>{const{keyCode:e}=t,s=Math.floor(e/32);this.keys[s]|=1<<e-32*s},this.keyUpHandler=t=>{const{keyCode:e}=t,s=Math.floor(e/32);this.keys[s]&=~(1<<e-32*s)},window.addEventListener("keyup",this.keyUpHandler),window.addEventListener("keydown",this.keyDownHandler)}isDown(t){const e=Math.floor(t/32);return 0!=(this.keys[e]&1<<t-32*e)}isUp(t){return!this.isDown(t)}}class st extends f{}t([u(E)],st.prototype,"animation",void 0);class it extends f{}t([u(k)],it.prototype,"asteroid",void 0),t([u(Y)],it.prototype,"position",void 0),t([u(I)],it.prototype,"collision",void 0),t([u(P)],it.prototype,"audio",void 0);class nt extends f{}t([u(P)],nt.prototype,"audio",void 0);class ot extends f{}t([u(b)],ot.prototype,"bullet",void 0);class at extends f{}t([u(b)],at.prototype,"bullet",void 0),t([u(Y)],at.prototype,"position",void 0),t([u(I)],at.prototype,"collision",void 0);class ht extends f{}t([u(R)],ht.prototype,"death",void 0);class rt extends f{}t([u(D)],rt.prototype,"state",void 0);class dt extends f{}t([u(O)],dt.prototype,"control",void 0),t([u(H)],dt.prototype,"gun",void 0),t([u(Y)],dt.prototype,"position",void 0),t([u(P)],dt.prototype,"audio",void 0);class lt extends f{}t([u(D)],lt.prototype,"state",void 0),t([u(_)],lt.prototype,"hud",void 0);class ct extends f{}t([u(U)],ct.prototype,"control",void 0),t([u(Y)],ct.prototype,"position",void 0),t([u(X)],ct.prototype,"motion",void 0);class ut extends f{}t([u(Y)],ut.prototype,"position",void 0),t([u(X)],ut.prototype,"motion",void 0);class pt extends f{}t([u(Y)],pt.prototype,"position",void 0),t([u(F)],pt.prototype,"display",void 0);class mt extends f{}t([u(j)],mt.prototype,"spaceship",void 0),t([u(Y)],mt.prototype,"position",void 0),t([u(I)],mt.prototype,"collision",void 0),t([u(P)],mt.prototype,"audio",void 0);class vt extends f{}t([u(j)],vt.prototype,"spaceship",void 0),t([u(Y)],vt.prototype,"position",void 0);class yt extends f{}t([u($)],yt.prototype,"wait",void 0);class ft extends N{constructor(){super(st)}updateNode(t,e){t.animation.animation.animate(e)}}class gt extends N{constructor(t,e){super(nt),this.audioContext=t,this.audioDB=e}updateNode(t,e){for(const e of t.audio.toPlay){const t=this.audioDB.get(e)||null,s=this.audioContext.createBufferSource();s.buffer=t,s.connect(this.audioContext.destination),s.start(0)}t.audio.toPlay.length=0}}class xt extends N{constructor(t){super(ot),this.creator=t}updateNode(t,e){const{bullet:s}=t;s.lifeTime-=e,s.lifeTime<=0&&this.creator.destroyEntity(t.entity)}}var wt;!function(t){t[t.asteroid=0]="asteroid",t[t.ship=1]="ship",t[t.shoot=2]="shoot"}(wt||(wt={}));const Ct=[{key:wt.asteroid,mp3:"652cd14a66ffc75b.mp3",ogg:"930cfba647e62b00.ogg"},{key:wt.shoot,mp3:"2520559ca39a00c2.mp3",ogg:"e25571a4800a2db8.ogg"},{key:wt.ship,mp3:"841ef5131f04838e.mp3",ogg:"919aafd2357b080a.ogg"}];function Lt(t){return e(this,void 0,void 0,(function*(){const s=new Map,i=function(){const t=document.createElement("audio"),e=t.canPlayType("audio/mpeg"),s=t.canPlayType("audio/ogg");let i=null;return"probably"===e?i="mp3":"probably"===s?i="ogg":"maybe"===e?i="mp3":"maybe"===s&&(i="ogg"),i}(),n=(i,n)=>e(this,void 0,void 0,(function*(){const e=yield fetch(i),o=yield e.arrayBuffer(),a=yield t.decodeAudioData(o);s.set(n,a)}));return i&&(yield Promise.all(Ct.map(t=>n(t[i],t.key)))),s}))}class Tt extends g{constructor(t){super(),this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null,this.creator=t}addToEngine(t){this.games=t.getNodeList(rt),this.spaceships=t.getNodeList(mt),this.asteroids=t.getNodeList(it),this.bullets=t.getNodeList(at)}update(t){for(let t=this.bullets.head;t;t=t.next)for(let e=this.asteroids.head;e;e=e.next){if(Y.distance(e.position,t.position)<=e.collision.radius){if(this.creator.destroyEntity(t.entity),e.collision.radius>10){const t=e.collision.radius-10;let s=e.position.x+10*Math.random()-5,i=e.position.y+10*Math.random()-5;this.creator.createAsteroid(t,s,i),s=e.position.x+10*Math.random()-5,i=e.position.y+10*Math.random()-5,this.creator.createAsteroid(t,s,i)}e.asteroid.fsm.changeState("destroyed"),e.audio.play(wt.asteroid),this.games.head&&(this.games.head.state.hits+=1);break}}for(let t=this.spaceships.head;t;t=t.next)for(let e=this.asteroids.head;e;e=e.next){if(Y.distance(e.position,t.position)<=e.collision.radius+t.collision.radius){t.spaceship.fsm.changeState("destroyed"),t.audio.play(wt.ship),this.games.head&&(this.games.head.state.lives-=1);break}}}removeFromEngine(t){this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null}}class At extends N{constructor(t){super(ht),this.creator=t}updateNode(t,e){t.death.countdown-=e,t.death.countdown<=0&&this.creator.destroyEntity(t.entity)}}class Mt extends g{constructor(t,e){super(),this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null,this.creator=t,this.config=e}addToEngine(t){this.games=t.getNodeList(rt),this.spaceships=t.getNodeList(vt),this.asteroids=t.getNodeList(it),this.bullets=t.getNodeList(at)}update(t){const e=this.games.head;if(e&&e.state.playing){if(this.spaceships.empty)if(e.state.lives>0){const t=this.config.width/2,e=this.config.height/2;let s=!0;for(let i=this.asteroids.head;i;i=i.next){if(Y.distance(i.position,{x:t,y:e})<=i.collision.radius+50){s=!1;break}}s&&this.creator.createSpaceship()}else e.state.playing=!1,this.creator.createWaitForClick();if(this.asteroids.empty&&this.bullets.empty&&this.spaceships.head){const t=this.spaceships.head;e.state.level+=1;const s=2+e.state.level;for(let e=0;e<s;e+=1){let e,s;do{e=Math.random()*this.config.width,s=Math.random()*this.config.height}while(Y.distance({x:e,y:s},t.position)<=80);this.creator.createAsteroid(30,e,s)}}}}removeFromEngine(t){this.games=null,this.spaceships=null,this.asteroids=null,this.bullets=null}}class St extends N{constructor(t,e){super(dt),this.keyPoll=t,this.creator=e}updateNode(t,e){const{control:s}=t,{position:i}=t,{gun:n}=t;n.shooting=this.keyPoll.isDown(s.trigger),n.timeSinceLastShot+=e,n.shooting&&n.timeSinceLastShot>=n.minimumShotInterval&&(this.creator.createUserBullet(n,i),t.audio.play(wt.shoot),n.timeSinceLastShot=0)}}class Nt extends N{constructor(){super(lt)}updateNode(t,e){t.hud.view.setLives(t.state.lives),t.hud.view.setScore(t.state.hits)}}class Et extends N{constructor(t){super(ct),this.keyPoll=t}updateNode(t,e){const{control:s}=t,{position:i}=t,{motion:n}=t;this.keyPoll.isDown(s.left)&&(i.rotation-=s.rotationRate*e),this.keyPoll.isDown(s.right)&&(i.rotation+=s.rotationRate*e),this.keyPoll.isDown(s.accelerate)&&(n.velocityX+=Math.cos(i.rotation)*s.accelerationRate*e,n.velocityY+=Math.sin(i.rotation)*s.accelerationRate*e)}}class kt extends N{constructor(t){super(ut),this.config=t}updateNode(t,e){const{position:s,motion:i}=t,{width:n,height:o}=this.config;if(s.x+=i.velocityX*e,s.y+=i.velocityY*e,s.x<0&&(s.x+=n),s.x>n&&(s.x-=n),s.y<0&&(s.y+=o),s.y>o&&(s.y-=o),s.rotation+=i.angularVelocity*e,i.damping>0){const t=Math.abs(Math.cos(s.rotation)*i.damping*e),n=Math.abs(Math.sin(s.rotation)*i.damping*e);i.velocityX>t?i.velocityX-=t:i.velocityX<-t?i.velocityX+=t:i.velocityX=0,i.velocityY>n?i.velocityY-=n:i.velocityY<-n?i.velocityY+=n:i.velocityY=0}}}class Pt extends g{constructor(t){super(),this.nodes=null,this.addToDisplay=t=>{const{displayObject:e}=t.display;this.container.appendChild(e.element),e.onAdded.dispatch()},this.removeFromDisplay=t=>{const{displayObject:e}=t.display;this.container.removeChild(t.display.displayObject.element),e.onRemoved.dispatch()},this.container=t}addToEngine(t){this.nodes=t.getNodeList(pt);for(let t=this.nodes.head;t;t=t.next)this.addToDisplay(t);this.nodes.nodeAdded.add(this.addToDisplay),this.nodes.nodeRemoved.add(this.removeFromDisplay)}update(t){for(let t=this.nodes.head;t;t=t.next){const{display:e,position:s}=t;e.displayObject.setTransform(s.x,s.y,s.rotation)}}removeFromEngine(t){this.nodes=null}}var bt;!function(t){t[t.preUpdate=1]="preUpdate",t[t.update=2]="update",t[t.move=3]="move",t[t.resolveCollisions=4]="resolveCollisions",t[t.animate=5]="animate",t[t.render=6]="render",t[t.audio=7]="audio"}(bt||(bt={}));class It extends g{constructor(t){super(),this.gameNodes=null,this.waitNodes=null,this.asteroids=null,this.creator=t}addToEngine(t){this.waitNodes=t.getNodeList(yt),this.gameNodes=t.getNodeList(rt),this.asteroids=t.getNodeList(it)}update(t){if(!this.waitNodes||!this.gameNodes||!this.asteroids)return;const e=this.waitNodes.head,s=this.gameNodes.head;if(e&&e.wait.startGame&&s){for(let t=this.asteroids.head;t;t=t.next)t.entity&&this.creator.destroyEntity(t.entity);s.state.setForStart(),e.wait.startGame=!1,e.entity&&this.creator.destroyEntity(e.entity)}}removeFromEngine(t){this.gameNodes=null,this.waitNodes=null,this.asteroids=null}}window.addEventListener("load",()=>e(void 0,void 0,void 0,(function*(){const t=document.getElementById("game");t&&(yield function(t){return e(this,void 0,void 0,(function*(){const e=new tt(t.clientWidth,t.clientHeight),s=new v,i=new Z(s,e),n=new et,o=new S,a=new AudioContext,h=yield Lt(a);o.add(t=>s.update(t)),o.start(),s.addSystem(new It(i),bt.preUpdate),s.addSystem(new Mt(i,e),bt.preUpdate),s.addSystem(new Et(n),bt.update),s.addSystem(new St(n,i),bt.update),s.addSystem(new xt(i),bt.update),s.addSystem(new At(i),bt.update),s.addSystem(new kt(e),bt.move),s.addSystem(new Tt(i),bt.resolveCollisions),s.addSystem(new ft,bt.animate),s.addSystem(new Nt,bt.animate),s.addSystem(new Pt(t),bt.render),s.addSystem(new gt(a,h),bt.audio),i.createWaitForClick(),i.createGame()}))}(t))})))}();
